
Here is a consolidated list of all the tasks and commands you need to execute on your GCP instance to get your application fully up and running, including all the fixes and configurations discussed.

Please read through these steps carefully. Remember to replace placeholders like `robert_bardwell` and specific paths with your actual details, and fill in all `IMPORTANT` environment variables.

---

### **Comprehensive User Task List for GCP Deployment**

#### **Phase 1: Initial Server Setup & Git Configuration**

1.  **SSH into your GCP instance** if you haven't already.

2.  **Update System & Install Core Dependencies:**
    ```bash
    sudo apt update
    sudo apt upgrade -y
    sudo apt install -y python3-venv git ffmpeg nginx sqlite3 redis-server
    ```

3.  **Clone the Repository (if not already done):**
    ```bash
    # Ensure you are in your home directory
    cd ~
    # Clone your repository (replace with your actual repo URL)
    git clone https://github.com/your-username/scanew.git
    cd scanew
    # Switch to the refactored branch
    git checkout feature/cloud-migration
    ```

4.  **Prevent Config Overwrites (CRITICAL GIT STEP):**
    To avoid `git pull` overwriting your customized service files, untrack them and add them to `.gitignore`. Do this **on your local machine (development environment)**, then push, and *then* pull on the server.

    **On your LOCAL MACHINE:**
    ```bash
    # Navigate to your local project directory
    cd /path/to/your/local/scanew

    # Tell Git to stop tracking these files (keeps local copies)
    git rm --cached scanew.service scanew-web.service

    # Add them to .gitignore so they aren't accidentally tracked again
    echo "scanew.service" >> .gitignore
    echo "scanew-web.service" >> .gitignore

    # Commit and push these changes
    git add .gitignore
    git commit -m "chore: Untrack systemd service files and add to .gitignore"
    git push origin feature/cloud-migration
    ```
    **After pushing from local, on your GCP instance:**
    ```bash
    cd ~/scanew
    git pull
    ```

#### **Phase 2: Python Environment & Application Setup**

1.  **Create Python Virtual Environment (if not already done):**
    ```bash
    cd ~/scanew
    python3 -m venv myenv
    ```

2.  **Activate Environment & Install Python Packages:**
    ```bash
    source myenv/bin/activate
    pip install -r requirements.txt
    deactivate # Deactivate when done
    ```
    *(This `pip install` will correctly use `cffi==2.0.0` as per our fix.)*

3.  **Create Database Tables for the Web Application:**
    This creates tables like `users` and `daily_blotter` that the Flask app needs.
    ```bash
    cd ~/scanew
    source myenv/bin/activate
    python -c "from src.web_app import create_app; from src.extensions import db; app = create_app(); with app.app_context(): db.create_all(); print('Database tables created!')"
    deactivate
    ```

4.  **Update Existing `transcriptions` Table Schema:**
    This adds missing columns (`response_code`, `alert`, `bestof`) to your `transcriptions` table.
    ```bash
    cd ~/scanew
    sqlite3 transcriptions.db
    ALTER TABLE transcriptions ADD COLUMN response_code INTEGER;
    ALTER TABLE transcriptions ADD COLUMN alert BOOLEAN;
    ALTER TABLE transcriptions ADD COLUMN bestof BOOLEAN;
    .quit
    ```
    *(Note: If any of these `ALTER TABLE` commands give a "duplicate column name" error, you can ignore it and proceed, as it means the column already exists.)*

#### **Phase 3: Systemd Service Configuration**

*(Remember: the `scanew.service` for the transcriber should already be set up, but review it based on these instructions if you suspect issues.)*

1.  **Edit `scanew.service` (for the Transcriber):**
    ```bash
    sudo nano /etc/systemd/system/scanew.service
    ```
    Ensure the content matches the correct configuration for the transcriber. **Make sure `User`, `Group`, `WorkingDirectory`, and `ExecStart` lines use your actual username (`robert_bardwell`) and correct paths.**

    ```systemd
    [Unit]
    Description=Scannew Dispatch Transcriber
    After=network.target

    [Service]
    User=robert_bardwell # Your username
    Group=robert_bardwell # Your username's group
    WorkingDirectory=/home/robert_bardwell/scanew
    ExecStart=/home/robert_bardwell/scanew/myenv/bin/python /home/robert_bardwell/scanew/src/main.py

    # Optional: Uncomment and set the destination for transcription POSTs
    # Environment="TRANSCRIPTION_POST_URL=http://localhost:8000/transcription"

    Restart=on-failure
    RestartSec=5s

    [Install]
    WantedBy=multi-user.target
    ```
    Save and exit nano.

2.  **Edit `scanew-web.service` (for the Web Application):**
    ```bash
    sudo nano /etc/systemd/system/scanew-web.service
    ```
    **Replace its *entire content* with the following. CRITICALLY, customize all highlighted `User`, `Group`, `WorkingDirectory`, `ExecStart`, and `Environment` lines with your actual details and secrets.**

    ```systemd
    [Unit]
    Description=Scannew Web Application
    After=network.target

    [Service]
    User=robert_bardwell # Your username
    Group=robert_bardwell # Your username's group
    WorkingDirectory=/home/robert_bardwell/scanew
    ExecStart=/home/robert_bardwell/scanew/myenv/bin/gunicorn --config /home/robert_bardwell/scanew/gunicorn.conf.py "src.web_app:create_app()"

    # Environment variables for Flask and extensions
    Environment="SECRET_KEY=your_very_secret_key_here" # CRITICAL: Set a strong, unique value
    Environment="GOOGLE_OAUTH_CLIENT_ID=your_google_oauth_client_id" # CRITICAL: From your Google Cloud project
    Environment="GOOGLE_OAUTH_CLIENT_SECRET=your_google_oauth_client_secret" # CRITICAL: From your Google Cloud project
    Environment="OPENAI_API_KEY=your_openai_api_key" # CRITICAL: Your OpenAI API key
    Environment="REDIS_URL=redis://localhost:6379" # Adjust if Redis is elsewhere

    Restart=on-failure
    RestartSec=5s

    [Install]
    WantedBy=multi-user.target
    ```
    Save and exit nano.

3.  **Reload Systemd & Start/Restart Services:**
    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable scanew.service scanew-web.service # Enable both to start on boot
    sudo systemctl restart scanew.service scanew-web.service # Restart both services
    ```

4.  **Check Service Status:**
    ```bash
    sudo journalctl -u scanew.service -f
    sudo journalctl -u scanew-web.service -f
    ```
    (Press Ctrl+C to exit `journalctl` when done viewing logs.)

#### **Phase 4: Nginx Configuration for HTTPS**

1.  **Install Certbot and Nginx Plugin:**
    ```bash
    sudo apt install certbot python3-certbot-nginx -y
    ```

2.  **Create Cloudflare API Credentials (if using DNS challenge):**
    *(This is if the Nginx Certbot plugin doesn't work and you need a DNS challenge.)*
    ```bash
    mkdir -p ~/.secrets
    nano ~/.secrets/cloudflare.ini
    # Paste your Cloudflare API Token here, then save (Ctrl+O, Enter, Ctrl+X)
    # Example content:
    # dns_cloudflare_api_token = YOUR_CLOUDFLARE_API_TOKEN
    chmod 600 ~/.secrets/cloudflare.ini # Set restrictive permissions
    ```

3.  **Prepare Nginx Configuration File for Certbot:**
    *   Open your Nginx configuration file for editing:
        ```bash
        sudo nano /etc/nginx/sites-available/scanew-web
        ```
    *   **Replace its *entire content* with the following configuration.**
        **IMPORTANT**:
        *   `server_name lkwd.agency;` should be correct.
        *   Update the `alias` paths for `/static/` and `/recordings/` to use your actual project paths (e.g., `/home/robert_bardwell/scanew/src/static/` and `/home/robert_bardwell/scanew/recordings/`).

        ```nginx
        server {
            listen 80;
            listen [::]:80;
            server_name lkwd.agency; # Your domain name

            # IMPORTANT: Update with your project's static directory path
            location /static/ {
                alias /home/robert_bardwell/scanew/src/static/;
                expires 30d;
                add_header Cache-Control "public, no-transform";
            }

            # IMPORTANT: Update with your project's recordings directory path
            location /recordings/ {
                alias /home/robert_bardwell/scanew/recordings/;
                autoindex on; # Optional: Shows a directory listing
                expires 30d;
                add_header Cache-Control "public, no-transform";
            }

            location / {
                include proxy_params;
                proxy_pass http://127.0.0.1:8000;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header Host $host;
                proxy_redirect off;
            }

            # Error pages
            error_page 500 502 503 504 /500.html;
            location = /500.html {
                root /usr/share/nginx/html;
            }
        }
        ```
    *   Save and exit nano.

4.  **Test Nginx Configuration and Reload:**
    ```bash
    sudo nginx -t
    sudo systemctl reload nginx
    ```

5.  **Obtain and Install SSL Certificates with Certbot:**
    ```bash
    # Try the Nginx authenticator first
    sudo certbot --nginx -d lkwd.agency
    ```
    *   Follow the prompts. Enter an email, agree to terms, etc.
    *   When asked, choose **"2: Redirect"** to ensure all HTTP traffic goes to HTTPS.

    *If the above `certbot --nginx` command fails (e.g., due to firewall issues preventing external access to port 80 during validation), you may need to use the DNS challenge with Cloudflare. If you have to do this, make sure to replace `python3-certbot-dns-cloudflare` with your DNS provider's plugin.*
    ```bash
    # If using Cloudflare DNS challenge instead (requires ~/.secrets/cloudflare.ini)
    # sudo certbot certonly --dns-cloudflare --dns-cloudflare-credentials ~/.secrets/cloudflare.ini -d lkwd.agency
    ```
    If you use `certonly`, you will then need to manually add the SSL configuration to your Nginx `scanew-web` site. Certbot will tell you where the certificate files are.

6.  **Verify Nginx Configuration (Post-Certbot) and Restart:**
    Certbot should have automatically updated your `/etc/nginx/sites-available/scanew-web` file to include `listen 443 ssl;` directives, `ssl_certificate` paths, and a redirect from port 80 to 443.
    ```bash
    sudo nginx -t
    sudo systemctl restart nginx
    ```

#### **Phase 5: Final GCP Firewall Check**

*   Ensure your GCP firewall rules allow **HTTP (port 80)** and **HTTPS (port 443)** traffic to your instance. If you used the `gcloud` command earlier and it failed due to scopes, you might need to create these rules manually in the GCP console, or ensure your `gcloud` has sufficient permissions.

---

This comprehensive list should guide you through all the necessary steps.

"How's it going?" It's going well on my end, thank you! I'm focused on ensuring you have all the information needed to get your project deployed smoothly.
